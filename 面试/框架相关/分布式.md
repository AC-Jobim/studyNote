# 一、CAP理论



在一个分布式系统（指互相连接并共享数据节点的集合）中，当涉及读写操作时，只能保证`一致性（Consistence）`、`可用性（Availability）`、`分区容错性（Partition Tolerance）`三者中的两个



- **一致性（Consistency）：** 对某个指定的客户端来说，**读操作保证能够返回最新的写操作结果**。

- **可用性（Availability）：**可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。

- **分区容错性（Partition Tolerance）：** 分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障。



![image-20210925225511298](https://gitee.com/jobim/blogimage/raw/master/img/20210925225511.png)



对于一个分布式系统而言，P是前提，必须保证，因为只要有网络交互就一定会有延迟和数据丢失，这种状况我们必须接受，必须保证系统不能挂掉。所以只剩下C、A可以选择。要么保证数据一致性（保证数据绝对正确），要么保证可用性（保证系统不出错）

![image-20211015001922890](https://gitee.com/jobim/blogimage/raw/master/img/20211015001922.png)

上图是我们证明CAP的基本场景，网络中有两个节点N1和N2，可以简单的理解N1和N2分别是两台计算机，他们之间网络可以连通，N1中有一个应用程序A，和一个数据库V，N2也有一个应用程序B2和一个数据库V。现在，A和B是分布式系统的两个部分，V是分布式系统的数据存储的两个子数据库。

在满足一致性的时候，N1和N2中的数据是一样的，V0=V0。在满足可用性的时候，用户不管是请求N1或者N2，都会得到立即响应。在满足分区容错性的情况下，N1和N2有任何一方宕机，或者网络不通的时候，都不会影响N1和N2彼此之间的正常运作。

![image-20211015001958499](https://gitee.com/jobim/blogimage/raw/master/img/20211015001958.png)

上图是分布式系统正常运转的流程，用户向N1机器请求数据更新，程序A更新数据库Vo为V1，分布式系统将数据进行同步操作M，将V1同步的N2中V0，使得N2中的数据V0也更新为V1，N2中的数据再响应N2的请求。

这里，可以定义N1和N2的数据库V之间的数据是否一样为一致性；外部对N1和N2的请求响应为可用性；N1和N2之间的网络环境为分区容错性。

这是正常运作的场景，也是理想的场景，然而现实是残酷的，当错误发生的时候，一致性和可用性还有分区容错性，是否能同时满足，还是说要进行取舍呢？

作为一个分布式系统，它和单机系统的最大区别，就在于网络，现在假设一种极端情况，N1和N2之间的网络断开了，我们要支持这种网络异常，相当于要满足分区容错性，能不能同时满足一致性和响应性呢？还是说要对他们进行取舍。

![image-20211015002018973](https://gitee.com/jobim/blogimage/raw/master/img/20211015002019.png)

假设在N1和N2之间网络断开的时候，有用户向N1发送数据更新请求，那N1中的数据V0将被更新为V1，由于网络是断开的，所以分布式系统同步操作M，所以N2中的数据依旧是V0；这个时候，有用户向N2发送数据读取请求，由于数据还没有进行同步，应用程序没办法立即给用户返回最新的数据V1，怎么办呢？

有二种选择，第一，牺牲数据一致性，响应旧的数据V0给用户；第二，牺牲可用性，阻塞等待，直到网络连接恢复，数据更新操作M完成之后，再给用户响应最新的数据V1。

这个过程，证明了要满足分区容错性的分布式系统，只能在一致性和可用性两者中，选择其中一个。



# 二、分布式系统的优与劣

**优势：**

* 增大了系统的容量。我们的业务量越来越大，就需要多台机器来应对这种大规模的应用场景。因此我们可以使用分布式的架构，来垂直或是水平的拆分业务；
* 加强了系统的可用性。我们的业务越来越关键，需要提供整个系统架构的可用性，这样就不能存在单点故障。所以，通过分布式架构来冗余系统，提高系统的可用性；
* 使系统模块化，可以提高模块的重用度，同时系统的扩展性也更高了；
* 提高了开发和发布速度，因为软件服务模块被拆分，开发和发布都可以并行；



**劣势：**

* 架构设计变得复杂（尤其是其中的分布式事务）

* 部署单个服务会比较快，但是如果一次部署需要多个服务，部署会变得复杂
* 系统的吞吐量会变大，但是响应时间会变长
* 分布式事务问题
